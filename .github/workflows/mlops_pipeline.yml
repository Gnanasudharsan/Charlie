name: MLOps Automated Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train_and_validate:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: "${{ github.workspace }}"

    steps:
      # 1) Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2) Python setup
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # 3) Install dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[all] fairlearn mlflow matplotlib seaborn \
                     scikit-learn joblib pyyaml lime shap plotly \
                     imbalanced-learn pandas numpy lightgbm \
                     google-cloud-storage google-cloud-artifact-registry google-auth

      # 4) Pull DVC data
      - name: Pull DVC Data
        run: |
          if [ -f "dvc.yaml" ]; then
            dvc pull || echo "âš ï¸ No DVC remote available."
          fi

      # 5) Train Model
      - name: Train Model
        run: python -m Model_Development.ml_src.model_train

      # 6) Hyperparameter Tuning
      - name: Hyperparameter Tuning
        run: python -m Model_Development.ml_src.model_tuning || echo "Skipping tuning."

      # 7) Bias Analysis
      - name: Bias & Fairness Check
        run: python -m Model_Development.ml_src.bias_analysis || echo "Skipping bias analysis."

      # 8) Explainability
      - name: Explainability (SHAP + LIME)
        run: python -m Model_Development.ml_src.explainability || echo "Skipping explainability."

      # 9) Model Selection
      - name: Select Best Model
        run: python -m Model_Development.ml_src.model_select || echo "Skipping model selection."

      # 10) Model Registry (Local MLflow)
      - name: Register Model
        run: python -m Model_Development.ml_src.register_model || echo "Skipping model registry."

      # 11) Drift Monitoring
      - name: Drift Monitoring
        run: python -m Model_Development.ml_src.monitor_drift || echo "Skipping drift monitoring."

      # 12) Upload artifacts
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: model-reports
          path: |
            models/
            reports/

      # 13) Push Model to GCP Artifact Registry
      - name: Push Model to GCP Artifact Registry
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project charlie-478223
          python -m Model_Development.ml_src.gcp_registry || echo "Upload skipped."

      # 14) Final Completion
      - name: Pipeline Completed
        run: echo "ðŸŽ‰ Pipeline execution finished!"