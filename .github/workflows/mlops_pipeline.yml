name: MLOps Automated Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train_and_validate:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: "${{ github.workspace }}"

    steps:
      # -----------------------------------------------------
      # 1) Checkout repo
      # -----------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2) Python setup
      # -----------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -----------------------------------------------------
      # 3) Install dependencies
      # -----------------------------------------------------
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[all] fairlearn mlflow matplotlib seaborn \
                     scikit-learn joblib pyyaml lime shap plotly \
                     imbalanced-learn pandas numpy lightgbm \
                     google-cloud-storage google-cloud-artifact-registry google-auth

      # -----------------------------------------------------
      # 4) Pull DVC data
      # -----------------------------------------------------
      - name: Pull DVC Data
        run: |
          if [ -f "dvc.yaml" ]; then
            echo "üì¶ Pulling data from DVC..."
            dvc pull || echo "‚ö†Ô∏è No DVC remote available."
          else
            echo "‚ÑπÔ∏è No dvc.yaml found. Skipping data pull."
          fi

      # -----------------------------------------------------
      # 5) Train Model
      # -----------------------------------------------------
      - name: Train Model
        run: |
          echo "üöÄ Training model..."
          python -m Model_Development.ml_src.model_train || echo "‚ö†Ô∏è Skipping training."

      # -----------------------------------------------------
      # 6) Hyperparameter Tuning
      # -----------------------------------------------------
      - name: Hyperparameter Tuning
        run: |
          echo "üîß Running tuning..."
          python -m Model_Development.ml_src.model_tuning || echo "‚ö†Ô∏è Skipping tuning."

      # -----------------------------------------------------
      # 7) Bias Analysis
      # -----------------------------------------------------
      - name: Bias & Fairness Check
        run: |
          echo "üìä Running bias analysis..."
          python -m Model_Development.ml_src.bias_analysis || echo "‚ö†Ô∏è Skipping bias analysis."

      # -----------------------------------------------------
      # 8) Explainability
      # -----------------------------------------------------
      - name: Explainability (SHAP + LIME)
        run: |
          echo "üß© Running explainability..."
          python -m Model_Development.ml_src.explainability || echo "‚ö†Ô∏è Skipping explainability."

      # -----------------------------------------------------
      # 9) Model Selection
      # -----------------------------------------------------
      - name: Select Best Model
        run: |
          echo "üèÜ Selecting best model..."
          python -m Model_Development.ml_src.model_select || echo "‚ö†Ô∏è Skipping model selection."

      # -----------------------------------------------------
      # 10) Model Registry (Local MLflow)
      # -----------------------------------------------------
      - name: Register Model
        run: |
          echo "üè∑Ô∏è Registering model..."
          python -m Model_Development.ml_src.register_model || echo "‚ö†Ô∏è Skipping model registry."

      # -----------------------------------------------------
      # 11) Drift Monitoring
      # -----------------------------------------------------
      - name: Drift Monitoring
        run: |
          echo "üìà Running drift monitoring..."
          python -m Model_Development.ml_src.monitor_drift || echo "‚ö†Ô∏è Skipping drift monitoring."

      # -----------------------------------------------------
      # 12) Upload artifacts to GitHub
      # -----------------------------------------------------
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: model-reports
          path: |
            Model_Development/models/
            Model_Development/reports/

      # -----------------------------------------------------
      # 13) Push Model to GCP Artifact Registry
      # -----------------------------------------------------
      - name: Push Model to GCP Artifact Registry
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project charlie-478223

          echo "‚òÅÔ∏è Uploading model to GCP Artifact Registry..."
          python -m Model_Development.ml_src.gcp_registry || echo "‚ö†Ô∏è Model registry upload skipped."

      # -----------------------------------------------------
      # 14) Final Completion
      # -----------------------------------------------------
      - name: Pipeline Completed
        run: echo "üéâ Pipeline execution finished!"